<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helpboard Legacy | Join Board</title>
    <!-- All Code Below Should Be Mirrored Across All Pages -->
    <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.classless.min.css">
    <script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.13.6/underscore-min.js"
        integrity="sha512-2V49R8ndaagCOnwmj8QnbT1Gz/rie17UouD9Re5WxbzRVUGoftCu5IuqqtAM9+UC3fwfHCSJR1hkzNQh/2wdtg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsonform/2.2.5/jsonform.js"
        integrity="sha512-7+/iHAMg7Yn0B7v6kbWoZYGstHvUeehAe0Rd77bndsvA0jk5z7fQt0qagSyvCRrr6pCBVDUUZlIXlcVhSv2l6g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/openpgp@latest/dist/openpgp.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/pouchdb@8.0.0/dist/pouchdb.min.js"></script>
    <!-- Ends here -->
</head>

<body>
    <header>
        <hgroup>
            <h1>Join Board</h1>
            <h2>Helpbard Legacy Build L1.0.1</h2>
        </hgroup>
        <nav>
            <ul>
                <li><button onclick="history.back()" role="button">Go Back</button></li>
                <li><a href="./settings.html" role="button">Settings</a></li>
            </ul>
        </nav>
        <hgroup>
            <form id="jhb"></form>
            <div id="console"></div>
        </hgroup>
    </header>
    <script type="module">
            import {net} from "./net.js"
            import {formSubmitter} from "./formHandle.js"
            $('#jhb').jsonForm({
                schema: {
                    fname: {
                        type: "string",
                        title: "First Name"
                    },
                    lname: {
                        type: "string",
                        title: "Last Name"
                    },
                    id: {
                        type: "number",
                        title: "Your Helpboard ID"
                    },
                    yq: {
                        type: "string",
                        title: "Your Question"
                    }
                },
                form: [{
                        key: "fname"
                    },
                    {
                        key: "lname"
                    },
                    {
                        key: "yq"
                    },
                    {
                        key: "id"
                    },
                    {
                        type: "submit",
                        title: "Connect"
                    }
                ],
                onSubmit: function(errors, values) {
                    $("[value='Connect']").attr("aria-busy", "true")
                    $("[value='Connect']").prop("disabled", true);
                    if (errors) {
                        $( "#console" ).append('<div>❌ Client Side Error Submitting Form!</div>');
                        $("[value='Connect']").attr("aria-busy", "false")
                        $("[value='Connect']").prop("disabled", false);
                    } else {
                        $( "#console" ).append('<div id="netstatus" aria-busy="true">Connecting to the Helpboard Network...</div>');
                        var client = new net.Client({boardid: values.id, cb: function(status){
                            if(status.status == "initalized"){
                                $( "#console" ).empty();
                                $( "#console" ).append('<div id="netstatus" aria-busy="false">HBN Status: Connected</div>');
                                $( "#console" ).append('<div>Successfully connected to the Helpboard Network using id: ' + values.id.toString() + '</div>');
                                $( "#console" ).append('<div id="formsubmit" aria-busy="true">Submitting Form</div>');

                                var form = new formSubmitter(client, function(status){
                                    if(status.status == "formsubmitsuccess"){
                                        $("#formsubmit").attr("aria-busy", "false")
                                        $("#console").append('<div>✅ Form Submitted Successfully</div>');
                                        $("[value='Connect']").prop("disabled", false);
                                        $("[value='Connect']").attr("aria-busy", "false")
                                    } else if(status.status == "formsubmitfail"){
                                        $("#console").append('<div>❌ Server Side Error Submitting Form!</div>');
                                        $("[value='Connect']").attr("aria-busy", "false")
                                        $("#formsubmit").attr("aria-busy", "false")
                                        $("[value='Connect']").prop("disabled", false);
                                    }
                                });

                                form.submit(values.fname + " " + values.lname, {Question: values.yq})

                                setTimeout(() => {
                                    if(form.success != true){
                                        $( "#console" ).empty();
                                        $( "#console" ).append('<div>❌ Error Submitting Form! Timed Out!</div>');
                                        $("[value='Connect']").attr("aria-busy", "false")
                                        $("#formsubmit").attr("aria-busy", "false")
                                        $("[value='Connect']").prop("disabled", false);
                                        form = null
                                    }
                                }, "60000")
                            }
                        }})

                        setTimeout(() => {
                            if(client.connectedToAdmin == false){
                                $( "#console" ).empty();
                                $( "#console" ).append('<div id="netstatus" aria-busy="false">HBN Status: Disconnected</div>');
                                $( "#console" ).append('<div>❌ Connection to the HBN timed out! Please try again!</div>');
                                $("[value='Connect']").attr("aria-busy", "false")
                                $("#formsubmit").attr("aria-busy", "false")
                                $("[value='Connect']").prop("disabled", false);
                                client = null
                            }
                        }, "60000")
                    }
                }
            });
      </script>
</body>

</html>